#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>

void usage(char *prog_name, char *filename)
{
    printf("Usage: %s <data to add to %s>", prog_name, filename);
    exit(0);
}

void fatal(char *);
void *ec_malloc(unsigned int);

int main(int argc, char *argv[])
{
    int fd;
    char *buffer, *datafile;

    buffer=(char*)ec_malloc(100);
    datafile=(char*)ec_malloc(20);
    strcpy(datafile, "/tmp/notes");

    if(argc<2)
        usage(argv[0], datafile);

    strcpy(buffer, argv[1]);

    printf("[DEBUG] buffer   @ %p: %s\n", buffer, buffer);
    printf("[DEBUG] datafile @ %p: %s\n", datafile, datafile);
    // add a newline character to note
    strncat(buffer, "\n", 1);
    // the open function returns a file descriptor
    fd=open(datafile, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
    if(fd==-1)
        fatal("main: Error opening file");

    printf("[DEBUG] File descriptor is %d\n", fd);

    // the write function takes in a file descriptor,
    // a pointer the data to write to the file, and
    // the number of bytes to write from the buffer into the file
    if(write(fd, buffer, strlen(buffer))==-1)
        fatal("main: Unable write to file");

    // the close function only takes in the file descriptor
    if(close(fd)==-1)
        fatal("main: Unable to close file successfully");

    printf("Note has been save to %s", datafile);
    printf("Freeing memory allocated on the heap");
    free(buffer);
    free(datafile);

    return 0;
}

void fatal(char *message)
{
    char err_msg[100];
    strcpy(err_msg, "[!!] Fatal Error ");
    strncat(err_msg, message, 83);
    perror(err_msg);
    exit(-1);
}

void *ec_malloc(unsigned int s)
{
    void *ptr;
    ptr==malloc(s);
    if(ptr==NULL)
        fatal("ec_malloc: Error allocating memory on the heap");
    return ptr;
}
